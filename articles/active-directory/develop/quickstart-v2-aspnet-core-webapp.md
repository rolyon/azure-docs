---
title: Azure AD v2.0 ASP.NET Core web app quickstart | Microsoft Docs
description: Learn how to implement Microsoft Sign-In on an ASP.NET Core Web App using OpenID Connect
services: active-directory
documentationcenter: dev-center-name
author: andretms
manager: mtillman
editor: ''

ms.assetid: 820acdb7-d316-4c3b-8de9-79df48ba3b06
ms.service: active-directory
ms.component: develop
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 09/25/2018
ms.author: andret
ms.custom: aaddev 

---

# Add sign-in with Microsoft to an ASP.NET Core web app

[!INCLUDE [active-directory-develop-applies-v2](../../../includes/active-directory-develop-applies-v2.md)]

This quickstart contains a code sample that demonstrates how an ASP.NET Core Web App can sign in personal (hotmail.com, live.com, others) and work and school accounts from any Azure Active Directory instance.

![How the sample app generated by this Quickstart works](media/quickstart-v2-aspnet-core-webapp/aspnetcorewebapp-intro.png)


> [!div renderon="docs"]
> ## Register your application and download your quickstart app
>
> ### Register and configure your application and code sample
> #### Step 1: Register your application
> 
> 1. Go to the [Microsoft Application Registration Portal](https://apps.dev.microsoft.com/portal/register-app).
> 1. Enter a name for your application, make sure the option for **Guided Setup** is unchecked, and click **Create**.
> 1. Click `Add Platform`, then select `Web`.
> 1. Make sure **Allow Implicit Flow** is *checked*.
> 1. In **Redirect URLs**, enter `https://localhost:3110/`.
> 1. Scroll down to the bottom of the page and click **Save**.

> [!div class="sxs-lookup" renderon="portal"]
> #### Step 1: Configure your application in Azure portal
> For the code sample for this quickstart to work, you need to add a reply URL as `http://localhost:3110/`.
> > [!div renderon="portal" id="makechanges" class="nextstepaction"]
> > [Make this change for me]()
>
> > [!div id="appconfigured" class="alert alert-info"]
> > ![Already configured](media/quickstart-v2-aspnet-core-webapp/green-check.png) Your application is configured with this attribute

#### Step 2: Download your ASP.NET Core project

- [Download the ASP.NET Core project](https://github.com/Azure-Samples/active-directory-aspnetcore-webapp-openidconnect-v2/archive/master.zip)

#### Step 3: Configure your project

1. Extract the zip file to a local folder (for example, **C:\Azure-Samples**)
1. If you use Visual Studio 2017, open the project in Visual Studio (optional)
1. Edit **appsettings.json** and replace the value for `ClientId` with the Application Id from the application you just registered:

    ```json
    "ClientId": "Enter_the_Application_Id_here"
    "TenantId": "common"
    ```
1. If your application is a *single-tenant application* (targeting accounts in the current directory only), in your **appsettings.json** file, find the value for `TenantId` and replace `common` with your **Tenant Id** or **Tenant name** (for example, contoso.microsoft.com). You can obtain the tenant name in the **Overview page**.

## More information

This section gives an overview of the code required to sign-in users. This can be useful to understand how the code works, main arguments, and also if you want to add sign-in to an existing ASP.NET Core application.

### Startup Class

*Microsoft.AspNetCore.Authentication* middleware uses a Startup class that is executed when the hosting process initializes:

```csharp
public void ConfigureServices(IServiceCollection services)
{
    services.AddAuthentication(sharedOptions =>
    {
        sharedOptions.DefaultScheme = CookieAuthenticationDefaults.AuthenticationScheme;
        sharedOptions.DefaultChallengeScheme = OpenIdConnectDefaults.AuthenticationScheme;
    })
    .AddAzureAd(options => Configuration.Bind("AzureAd", options))
    .AddCookie();

    services.AddMvc();
}
```

The method `AddAuthentication` configures the service to add Cookie-based authentication - used on browser scenarios, as well as set the challenge to OpenIdConnect. 

The line containing `.AddAzureAd` adds the Azure Active Directory Authentication to your application.

Besides that, the file **AzureAdAuthenticationBuilderExtensions.cs** adds extension method to AzureAd Authentication pipeline. This extension method configure the attributes needed for Azure AD Authentication. The `Configure` method in `IConfigureNamedOptions` interface contains the following:

```csharp
public void Configure(string name, OpenIdConnectOptions options)
{
    options.ClientId = _azureOptions.ClientId;
    options.Authority = $"{_azureOptions.Instance}common/v2.0";   // V2 specific
    options.UseTokenLifetime = true;
    options.RequireHttpsMetadata = false;
    options.TokenValidationParameters.ValidateIssuer = false;     // accept several tenants (here simplified)
}
```
> |Where  |  |
> |---------|---------|
> |ClientId     |Application Id from the application registered in the Azure portal|
> |Authority | The STS endpoint fo user to authenticate. Usually https://login.microsoftonline.com/{tenant}/v2.0 for public cloud, where {tenant} is the name of your tenant, your tenant Id, or *common* for a reference to the common endpoint (used for multi-tenant applications)|
> |UseTokenLifetime |Indicates that the authentication cookie should match that of the authentication token|
> |RequireHttpsMetadata     |Require HTTPS for the metadata address or authority. It is recommended to change this value to `True`|
> |TokenValidationParameters     | A list of parameters for token validation. In this case, `ValidateIssuer` is set to `false` to indicate that it can accept sign-ins from any personal, or work or school accounts|

### Initiate an authentication challenge

You can force user to sign in by requesting an authentication challenge in your controller just like in **AccountController.cs**:

```csharp
public IActionResult SignIn()
{
    var redirectUrl = Url.Action(nameof(HomeController.Index), "Home");
    return Challenge(
        new AuthenticationProperties { RedirectUri = redirectUrl },
        OpenIdConnectDefaults.AuthenticationScheme);
}
```

> [!TIP]
> Requesting an authentication challenge using the method above is optional and commonsly used when you want a view to be available for both authenticated and non-authenticated users. You can protect controllers by using the method described in the next section.

### Protect a controller or a controller's method

You can protect a controller or controller methodss using the `[Authorize]` attribute. This attribute restricts access to the controller or methods by only allowing authenticated users - which means that authentication challenge can be started to access the controller if user is not authenticated.

## Next Steps

Check out the GitHub repo for this ASP.NET Core Quickstart for more information - including instructions on how to add authentication to a brand new ASP.NET Core Web application:

> [!div class="nextstepaction"]
> [ASP.NET Core Web App Code Sample](https://github.com/Azure-Samples/active-directory-aspnetcore-webapp-openidconnect-v2/)

[!INCLUDE [Help and support](../../../includes/active-directory-develop-help-support-include.md)]